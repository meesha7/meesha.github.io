<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Writing a Rego syntax definition for Sublime Text (unfinished)</title>
  <link rel="shortcut icon" type="image/png" href="https://staticf0x.github.io/images/favicon-32.png" sizes="32x32">
  <link rel="shortcut icon" type="image/png" href="https://staticf0x.github.io/images/favicon-128.png" sizes="128x128">
  <link rel="shortcut icon" type="image/png" href="https://staticf0x.github.io/images/favicon-192.png" sizes="192x192">

  <meta name="description" content="A personal blog about Python, Rust, Linux and related stuff" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="https://staticf0x.github.io/2022/writing-a-rego-syntax-definition-for-sublime-text-unfinished.html" rel="canonical" />
  <!-- Feed -->

  <link href="https://staticf0x.github.io/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="https://staticf0x.github.io/theme/css/code_blocks/monokai.css" rel="stylesheet">


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="Note: As of 2023 I gave up on finishing this syntax definition. I will leave what I have written down up until now here for future...">

    <meta name="author" content="staticf0x">

    <meta name="tags" content="Rego">
    <meta name="tags" content="Sublime Text">




<!-- Open Graph -->
<meta property="og:site_name" content="Snake pit"/>
<meta property="og:title" content="Writing a Rego syntax definition for Sublime Text (unfinished)"/>
<meta property="og:description" content="Note: As of 2023 I gave up on finishing this syntax definition. I will leave what I have written down up until now here for future..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://staticf0x.github.io/2022/writing-a-rego-syntax-definition-for-sublime-text-unfinished.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2022-03-15 00:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://staticf0x.github.io/author/staticf0x.html">
<meta property="article:section" content="articles"/>
<meta property="article:tag" content="Rego"/>
<meta property="article:tag" content="Sublime Text"/>
<meta property="og:image" content="https://staticf0x.github.io/theme/images/home-bg.jpg">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Writing a Rego syntax definition for Sublime Text (unfinished)",
  "headline": "Writing a Rego syntax definition for Sublime Text (unfinished)",
  "datePublished": "2022-03-15 00:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "staticf0x",
    "url": "https://staticf0x.github.io/author/staticf0x.html"
  },
  "image": "https://staticf0x.github.io/theme/images/home-bg.jpg",
  "url": "https://staticf0x.github.io/2022/writing-a-rego-syntax-definition-for-sublime-text-unfinished.html",
  "description": "Note: As of 2023 I gave up on finishing this syntax definition. I will leave what I have written down up until now here for future..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <img src="/images/pfp.jpeg" alt="Profile picture" style="width: 200px; text-align: center; border-radius: 50%;">
    <ul>

              <li role="presentation"><a href="https://staticf0x.github.io/pages/about.html">About</a></li>

          <li><a href="/tags.html" role="presentation">Tags</a></li>
          <li><a href="/archives.html" role="presentation">Archive</a></li>

    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://staticf0x.github.io/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">Writing a Rego syntax definition for Sublime Text (unfinished)</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://staticf0x.github.io/author/staticf0x.html">staticf0x</a>
            | <time datetime="Tuesday, March 15, 2022">Tuesday, March 15, 2022</time>
        </span>
            <div class="post-cover cover" style="background-image: url('https://staticf0x.github.io/theme/images/home-bg.jpg')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <blockquote>
<p><strong>Note</strong>: As of 2023 I gave up on finishing this syntax definition.
            I will leave what I have written down up until now here
            for future reference for anyone who'd like to start
            writing their own syntax definitions. The repo
            on <a href="https://github.com/staticf0x/RegoSyntax">my github</a> is free to be forked and worked on.</p>
</blockquote>
<p>Rego is a language used for <a href="https://www.openpolicyagent.org/docs/latest/policy-testing/">Policy Testing</a>.
It's not a particularly complex language. However, there is no syntax
definition for Sublime Text yet. This blog post is about trying
to write at least a basic syntax definition so the code is properly highlighted.</p>
<p>The related docs can be found here:</p>
<ul>
<li><a href="https://www.sublimetext.com/docs/syntax.html">Syntax Definitions</a></li>
<li><a href="https://www.sublimetext.com/docs/scope_naming.html">Scope Naming</a></li>
</ul>
<p>The full repo can be found <a href="https://github.com/staticf0x/RegoSyntax">here</a>.</p>
<h2>Basic structure</h2>
<p>We'll start by adding a new package to Sublime Text. The path will be
<code>~/.config/sublime-text/Packages/User/RegoSyntax</code>.</p>
<p>A basic syntax definition has some metadata:</p>
<div class="highlight"><pre><span></span><code><span class="nt">%YAML</span><span class="w"> </span><span class="m">1.2</span>
<span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Rego</span>
<span class="nt">file_extensions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rego</span>
<span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source.rego</span>
</code></pre></div>

<p>We'll assign <code>source.rego</code> to file extension <code>.rego</code>.</p>
<h2>Highlighting comments</h2>
<p>Comments in Rego use <code>#</code>. We'll add a new match to the main context:</p>
<div class="highlight"><pre><span></span><code><span class="nt">contexts</span><span class="p">:</span>
<span class="w">  </span><span class="nt">main</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^\s*#.*\n</span>
<span class="w">      </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">comment.line</span>
</code></pre></div>

<p>This is enough for Sublime Text to highlight comments.
We'll take any number of whitespace after a start of line (<code>^\s*</code>),
followed by the comment sign (<code>#</code>), followed by anything until the end of
the line (<code>.*\n</code>).</p>
<p>To verify this is working, we can go to any Rego file, open the Sublime Text
console (<kbd>Ctrl</kbd> + <kbd>`</kbd>) and check the context:</p>
<p><code>view.scope_name(view.sel()[0].end())</code></p>
<p>which should give us</p>
<p><code>source.rego comment.line</code></p>
<p>Now Sublime Text will highlight this as comments. However, the scope is
not exactly correct.</p>
<p>If you try it with Python, for example, you'll get this:</p>
<p><code>source.python comment.line.number-sign.python</code></p>
<p>You may know about <a href="https://github.com/Suor/CommentsAwareEnter">CommentsAwareEnter</a> package, which keeps the comments
while you hit <kbd>Enter</kbd>.</p>
<p>This package uses the scope name to be aware that you are editing a comment.
However, if we only have <code>source.rego comment.line</code>, the package will
end with an exception, because it expects a more detailed scope.</p>
<p>So while Sublime Text highlights the comment just fine, the scope needs
to be expanded to <code>comment.line.number-sign.rego</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">contexts</span><span class="p">:</span>
<span class="w">  </span><span class="nt">main</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^\s*#.*\n</span>
<span class="w">      </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">comment.line.number-sign.rego</span>
</code></pre></div>

<p>Now the highlighting works and the CommentsAwareEnter package as well.</p>
<p>One more thing I had to borrow from other syntax definitions is a file
called <code>Comments.tmPreferences</code>, which enables Sublime Text to toggle comments
with a shortcut (default key binding is <kbd>Ctrl</kbd> + <kbd>/</kbd>).</p>
<p>The file looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
<span class="nt">&lt;plist</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>name<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;string&gt;</span>Comments<span class="nt">&lt;/string&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>scope<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;string&gt;</span>source.rego<span class="nt">&lt;/string&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>settings<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;dict&gt;</span>
<span class="w">        </span><span class="nt">&lt;key&gt;</span>shellVariables<span class="nt">&lt;/key&gt;</span>
<span class="w">        </span><span class="nt">&lt;array&gt;</span>
<span class="w">            </span><span class="nt">&lt;dict&gt;</span>
<span class="w">                </span><span class="nt">&lt;key&gt;</span>name<span class="nt">&lt;/key&gt;</span>
<span class="w">                </span><span class="nt">&lt;string&gt;</span>TM_COMMENT_START<span class="nt">&lt;/string&gt;</span>
<span class="w">                </span><span class="nt">&lt;key&gt;</span>value<span class="nt">&lt;/key&gt;</span>
<span class="w">                </span><span class="nt">&lt;string&gt;</span>#<span class="w"> </span><span class="nt">&lt;/string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/dict&gt;</span>
<span class="w">        </span><span class="nt">&lt;/array&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/plist&gt;</span>
</code></pre></div>

<h2>Strings</h2>
<p>A string in Rego is not special, it starts and ends with <code>"</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&quot;&#39;</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</code></pre></div>

<p>However, here we will not match a single string on one line. We can have more
than one and we want to highlight them all. In this case, after matching a <code>"</code>,
we'll push a context named <code>string</code>.</p>
<p>The context then looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">contexts</span><span class="p">:</span>
<span class="w">  </span><span class="nt">main</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&quot;&#39;</span>
<span class="w">      </span><span class="nt">push</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>

<span class="w">  </span><span class="nt">string</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">meta_scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string.quoted.rego</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\\.</span>
<span class="w">      </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">constant.character.escape.rego</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&quot;&#39;</span>
<span class="w">      </span><span class="nt">pop</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>

<p>When we match another <code>"</code>, which is <em>not escaped</em>, we'll pop the context
and the string ends. For this, we define the <code>constant.character.escape.rego</code>
scope.</p>
<h2>Curly braces</h2>
<p>Sublime Text will highlight the opening and closing bracket/brace/etc. In Rego
a block is defined by <code>{}</code>. Let's tell Sublime to recognize them:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\{</span>
<span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">punctuation.section.block.start.rego</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\}</span>
<span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">punctuation.section.block.end.rego</span>
</code></pre></div>

<blockquote>
<p><strong>Note</strong>: At this point I also wanted to write about defining variables,
            built-ins and other elements, but I no longer have the time
            nor motivation to finish this. If I ever come back to this,
            I'll update the article.</p>
</blockquote>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw?text=Writing a Rego syntax definition for Sublime Text (unfinished)&amp;url=https://staticf0x.github.io/2022/writing-a-rego-syntax-definition-for-sublime-text-unfinished.html" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://staticf0x.github.io/tag/rego.html">Rego</a><a href="https://staticf0x.github.io/tag/sublime-text.html">Sublime Text</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">


                        <figure class="post-author-avatar">
                            <img src="https://staticf0x.github.io/images/pfp.jpeg" alt="staticf0x" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://staticf0x.github.io/author/staticf0x.html">staticf0x</a></h4>
                            <span class="post-author-location"><i class="ic ic-location"></i> Europe</span>
                        <!-- Social linkes in alphabet order. -->
                            <span class="post-author-github"><a target="_blank" href="https://github.com/staticf0x"><i class="ic ic-link"></i> GitHub</a></span>
                    </div>
                    <div class="clear"></div>
                </aside>

                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">

            <a class="github-link" href="https://github.com/staticf0x" target="_blank"><i class="ic ic-link"></i> GitHub</a>


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script type="text/javascript" src="https://staticf0x.github.io/theme/js/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://staticf0x.github.io/theme/js/script.js"></script>

</body>
</html>